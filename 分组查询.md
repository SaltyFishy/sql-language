# sql-learning in week7(using MySQL)
<h2>分组查询</h2>
引入：在分组函数曾提到我们可以使用AVG函数计算出工资平均值。<br>
如：select AVG(salary) from employees;<br>
但我们考虑这样的一个情况：统计每个部门的平均工资。<br>
注意到这里的要求同直接计算平均工资的不同，直接计算的平均工资，相当于将所有的部门视为一个“组”，对整个“组”求平均值，而统计每个部门的时候，是按照部门的类别分“组”。这就是我们将要提到的分“组”的概念。
也就是group by子句的使用。
<h3>基本结构</h3>
select 分组函数,列名 from 表名 where 筛选条件 group by 需要被分组的列 order by 排序条件;<br>
group by后面的列必须在查询列表里
<h3>简单使用</h3>
例1：查询每个工种的最高工资

```mysql
SELECT MAX(salary),job_id FROM employees GROUP BY job_id;
```
<br>
例2：查询每个位置上的部门个数

```mysql
SELECT COUNT(*),location_id FROM departments GROUP BY location_id;
```
<br>
<h3>添加where筛选条件（分组前）</h3>
例：查询邮箱中包含字符a的，每个部门的平均工资

```mysql
SELECT AVG(salary),department_id FROM employees WHERE email LIKE '%a%' GROUP BY department_id;
```
<br>
例：查询有奖金的每个领领导手下员工的最高工资

```mysql
SELECT MAX(salary),manager_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY manager_id;
```
<br>
<h3>添加having筛选条件（分组后）</h3>
例：查询哪个部门的员工数>2<br>
分析：首先我们要查询每个部门的员工数，然后再筛选出其中的员工数大于2的部门。也就是进行二次查询，第二次查询在第一次查询的基础上继续查询，使用having关键字。<br>
<strong>注意与where筛选条件的本质区别，where筛选条件是在分组之前进行的筛选（满足where条件的数据会被放入虚拟表），而having是在分组之后（并且having的本质是对查询语句select查询的字段进行筛选，满足的数据会输出，不满足不输出，但是无论是否满足条件该数据都已经存在于虚拟表内部了）</strong>

```mysql
SELECT COUNT(*),department_id FROM employees GROUP BY department_id HAVING COUNT(*)>2;
```
<br>
例：查询每个工种有奖金的员工的最高工资>12000的工种编号和最高工资<br>
分析：首先查询每个工种有奖金的员工的最高工资，再跟与第一个条件继续筛选最高工资大于12000

```mysql
SELECT MAX(salary),job_id FROM employees WHERE commission_pct IS NOT NULL GROUP BY job_id HAVING MAX(salary)>12000;
```
<br>
例：查询领导编号大于102的每个领导手下的最低工资大于5000的领导编号是哪个，以及其最低工资<br>
分析：首先查询领导编号大于102的每个领到手下的员工的最低工资，再查询最低工资大于5000

```mysql
SELECT MIN(salary),manager_id FROM employees WHERE manager_id GROUP BY manager_id HAVING MIN(salary)>5000;
```
<br>
<h3>分组前及分组后筛选总结</h3>
分组前筛选：
<ul>
	<li>是对原始表进行筛选</li>
	<li>用where</li>
	<li>放在from后group by前</li>
</ul>
分组后筛选：
<ul>
	<li>是对分组后产生的虚拟表进行筛选</li>
	<li>用having</li>
	<li>放在group by后</li>
</ul>
<strong>分组函数做条件肯定放在having子句内</strong><br>
<strong>能用分组前筛选的，尽量用分组前筛选</strong><br>
<h3>按函数分组</h3>
例：按员工姓名的长度分组、查询每一组的员工个数，筛选员工个数大于5的有哪些

```mysql
SELECT COUNT(*) FROM employees GROUP BY LENGTH(last_name + first_name) HAVING COUNT(*) > 5;
```
<br>
<h3>按多个字段分组</h3>
例：查询每个部门每个工种的员工的平均工资

```mysql
SELECT AVG(salary),department_id,job_id FROM employees GROUP BY department_id,job_id;
```
<br>
顺序没有影响
<h3>添加排序</h3>
例：查询每个部门每个工种的员工的平均工资，并且按照平均工资的高低显示

```mysql
SELECT AVG(salary),department_id,job_id FROM employees GROUP BY department_id,job_id ORDER BY AVG(salary) DESC;
```
<br>
<h2>分组查询总结</h2>
<ol>
	<li>group by支持单个字段、多个字段、表达式、函数</li>
	<li>支持别名</li>
	<li>可添加order by进行排序</li>
</ol>

