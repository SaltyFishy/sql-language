# sql-learning in week9(using MySQL)
<h2>子查询</h2>
含义：出现在其他语句（包括update等）中的select语句<br>
出现在外部的称为主查询或外查询。<br>
分类（按位置）：
<oL>
	<li>select后面</li>
	<li>from后面</li>
	<li>where/having后面</li>
	<li>exists后面（相关子查询）</li>
</ol>
分类（按结果的行列数）：
<oL>
	<li>标量子查询（结果只有一行一列）</li>
	<li>列子查询（一列多行）</li>
	<li>行子查询（一行多列）</li>
	<li>表子查询（多行多列）</li>
</ol>
<img src="https://github.com/SaltyFishy/sql-language/blob/week9/%E5%AD%90%E6%9F%A5%E8%AF%A2%E5%8F%8A%E5%85%B6%E4%BD%8D%E7%BD%AE%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%8C%B9%E9%85%8D.jpg" alt="子查询及其位置与结果匹配">
<h3>where或having后</h3>
<ul>
	<li>标量子查询（单行子查询）</li>
	<li>列子查询（多行子查询）</li>
	<li>行子查询（多列多行）</li>
</ul>
<img src="https://github.com/SaltyFishy/sql-language/blob/week9/%E6%A0%87%E9%87%8F%E5%AD%90%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%89%B9%E7%82%B9.jpg" alt="标量子查询的特点">
<h4>标量子查询</h4>
例1：谁的工资比Abel高？
步骤：
<ol>
	<li>查询Abel的工资<br>

```mysql
SELECT salary 
FROM employees
WHERE last_name = 'Abel';
```
<br>
	</li>
	<li>查询员工的信息，满足salary>的结果<br>

```mysql
SELECT * 
FROM employees
WHERE salary > (
	SELECT salary 
	FROM employees
	WHERE last_name = 'Abel'
);
```
<br>
	</li>
</ol>
例2：返回job_id与141号员工相同，salary比143号员工多的员工的姓名，job_id和工资
步骤：
<ol>
	<li>查询141号员工的job_id<br>

```mysql
SELECT job_id
FROM employees
WHERE employee_id = 141;
```
<br>
	</li>
	<li>查询143号员工的salary<br>

```mysql
SELECT salary
FROM employees
WHERE employee_id = 143;
```
<br>
	</li>
		<li>查询满足两个条件的员工的姓名、job_id和salary<br>

```mysql
SELECT last_name,job_id,salary
FROM employees
WHERE salary > (
	SELECT salary
	FROM employees
	WHERE employee_id = 143
) 
AND job_id = (
	SELECT job_id
	FROM employees
	WHERE employee_id = 141
);
```
<br>
	</li>
</ol>
<strong>可以发现查询支持多个子查询</strong><br>
例3：返回公司工资最少的员工的last_name,job_id,salary
<ol>
	<li>查询公司的最低工资<br>

```mysql
SELECT MIN(salary)
FROM employees;
```
<br>
	</li>
	<li>查询员工的last_name,job_id,salary且salary为最低<br>

```mysql
SELECT last_name,job_id,salary
FROM employees
WHERE salary = (
	SELECT MIN(salary)
	FROM employees
);

```
<br>
	</li>
</ol>
例4：查询最低工资大于50号部门最低工资的部门的id和其最低工资
<ol>
	<li>查询50号部门最低工资<br>

```mysql
SELECT MIN(salary)
FROM employees
WHERE department_id = 50;
```
<br>
	</li>
	<li>查询每个部门的最低工资<br>

```mysql
SELECT MIN(salary)
FROM employees
GROUP BY department_id;
```
<br>
	</li>
	<li>筛选满足条件的部门<br>

```mysql
SELECT department_id,MIN(salary)
FROM employees
GROUP BY department_id
HAVING MIN(salary) > (
	SELECT MIN(salary)
	FROM employees
	WHERE department_id = 50
);
```
<br>
	</li>
</ol>
<strong>可以发现查询支持分组函数</strong>
<h5>容易出现的错误</h5>
<strong>1.在单行操作符中使用了非标量子查询</strong><br>
<strong>2.标量子查询的子查询查询错误导致查询结果不是一行一列</strong><br>
<h4>列子查询（一列多行）</h4>
使用列子查询需要搭配多行操作符<br>
<ol>
	<li>in/not in等于列表中的任意一个</li>
	<li>any/some和子查询返回的某一个值比较</li>
	<li>all和子查询返回的所有值比较</li>
</ol>
例1：返回location_id为1400或1700的部门中的所有员工姓名
<ol>
	<li>查询location_id为1400或1700的部门编号<br>

```mysql
SELECT department_id
FROM departments
WHERE location_id IN (1400,1700);
```
<br>
	</li>
	<li>查询满足条件的员工姓名<br>

```mysql
SELECT last_name
FROM employees
WHERE department_id IN (
	SELECT department_id
	FROM departments
	WHERE location_id IN (1400,1700)
);
```
<br>
或<br>

```mysql
SELECT last_name
FROM employees
WHERE department_id = ANY (
	SELECT department_id
	FROM departments
	WHERE location_id IN (1400,1700)
);
```
<br>
	</li>
</ol>
例2：返回其他工种中比job_Id为'IT_PROG'工种任一工资低的员工的员工号，姓名、job_id和salary
<ol>
	<li>查询job_Id为'IT_PROG'部门的员工的工资<br>

```mysql
SELECT salary
FROM employees
WHERE job_id = 'IT_PROG';
```
<br>
	</li>
	<li>查询满足条件的员工号，姓名、job_id和salary<br>

```mysql
SELECT last_name,job_id,salary,employee_id
FROM employees
WHERE salary < ANY(     
	SELECT salary
	FROM employees
	WHERE job_id = 'IT_PROG'
) AND job_id <> 'IT_PROG';
```
<br>
	</li>
</ol>
例3：返回其他工种中比job_Id为'IT_PROG'工种所有工资低的员工的员工号，姓名、job_id和salary
<ol>
	<li>ALL写法<br>

```mysql
SELECT last_name,job_id,salary,employee_id
FROM employees
WHERE salary < ALL(     
	SELECT DISTINCT salary
	FROM employees
	WHERE job_id = 'IT_PROG'
) AND job_id <> 'IT_PROG';
```
<br>
	</li>
	<li>min写法<br>

```mysql
SELECT last_name,job_id,salary,employee_id
FROM employees
WHERE salary < (     
	SELECT MIN(salary)
	FROM employees
	WHERE job_id = 'IT_PROG'
) AND job_id <> 'IT_PROG';
```
<br>
	</li>
</ol>
<h4>行子查询（一行多列或多行多列）</h4>
使用少<br>
例1：查询最小的员工编号并且工资最高的员工信息<br>
简单写法：
<ol>
	<li>查询最小的员工编号

```mysql
SELECT MIN(employee_id)
FROM employees;
```
<br>
	</li>
	<li>查询最高工资

```mysql
SELECT MAX(salary)
FROM employees;
```
<br>
	</li>
	<li>查询员工信息

```mysql
SELECT *
FROM employees
WHERE salary = (
SELECT MAX(salary)
FROM employees
) 
AND employee_id = (
SELECT MIN(employee_id)
FROM employees
);
```
<br>
	</li>
</ol>
行子查询写法：

```mysql
SELECT *
FROM employees
WHERE (employee_id,salary) = (
	SELECT MIN(employee_id),MAX(salary)
	FROM employees
);
```
<br>
<strong>注意，employee_id,salary的顺序在子查询跟父查询的顺序必须一致，并且使用行子查询的条件必须是=</strong>
<h3>select后</h3>
注意查询结果为原表+查询字段<br>
例1：查询每个部门的员工个数

```mysql
SELECT d.*,(
	SELECT COUNT(*)
	FROM employees e
	WHERE e.department_id = d.department_id
)
FROM departments d;
```
<br>
例2：查询员工号=102的部门名

```mysql
SELECT (
	SELECT department_name
	FROM departments d
	INNER JOIN employees e
	ON d.department_id = e.department_id
	WHERE e.employee_id = 102
);
```
<br>
<h3>from后（多行多列）</h3>
例1：查询每个部门的平均工资的工资等级
<ol>
	<li>查询每个部门的平均工资

```mysql
SELECT AVG(salary)，department_id
FROM employees
GROUP BY department_id;
```
<br>
	</li>
	<li>链接前面的结果表与job_grades表，筛选条件平均工资between lowest_sal and highest_sal

```mysql
SELECT AVG(salary) avg_sal,department_id
FROM employees
GROUP BY department_id;
```
<br>
	</li>
	<li>查询对应的工资等级

```mysql
SELECT avg_dep.*,grade_level
FROM (
	SELECT AVG(salary) avg_sal,department_id
	FROM employees
	GROUP BY department_id
) avg_dep
INNER JOIN  job_grades j
ON avg_dep.avg_sal BETWEEN j.`lowest_sal` AND j.`highest_sal`;
```
<br>
	</li>
</ol>
<strong>注意（）的表必须写别名</strong>
<h3>exists后（相关子查询）</h3>
exists()返回查询的结果是否存在，存在为1，不存在为0<br>
exists(完整的查询语句)<br>
结果只有1/0<br>
例1：查询有员工的部门名

```mysql
SELECT department_name
FROM departments d
WHERE EXISTS(
	SELECT *
	FROM employees e
	WHERE e.department_id = d.department_id
);
```
<br>
用in的方式：

```mysql
SELECT department_name
FROM departments d
WHERE d.department_id IN (
	SELECT department_id
	FROM employees
);
```
<br>
例2：查询没有女朋友的男生信息


```mysql
SELECT * 
FROM boys bo
WHERE NOT EXISTS( #此处可写为!EXISTS
	SELECT *
	FROM beauty b
	WHERE b.`boyfriend_id` = bo.`id`
);
```
<br>
用in的方式：

```mysql
SELECT *
FROM boys 
WHERE id NOT IN (
	SELECT boyfriend_id
	FROM beauty
);
```
<br>
<strong>先执行主查询，后执行子查询</srtong>

